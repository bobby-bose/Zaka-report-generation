<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Packing List - Add</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="/static/vendor/bootstrap/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f7f7f7;
    }
    .header-logo {
      height: 80px;
      width: 200px;
      background: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .form-label {
      font-weight: bold;
      color: #000;
      font-size: 1.1rem;
    }
    .card-section {
      border: 2px solid #000;
      border-radius: 8px;
      padding: 1rem;
      background: #fff;
      margin-bottom: 1rem;
    }
    .item-card {
      border: 2px solid red;
      border-radius: 8px;
    }
    .btn-add-item {
      border: 2px solid red;
      font-weight: 600;
    }
    .btn-item-plus {
      border: 2px solid red;
      font-size: 1.2rem;
      line-height: 1;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .box-row {
      margin-bottom: 0.75rem;
    }
    .box-row .form-control {
      min-width: 70px;
    }

    .table-group {
      border: 2px solid red;
      border-radius: 8px;
      background: #fff;
      padding: 1rem;
    }

    .desc-input {
      min-height: 42px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div style="text-align: center; padding: 2vh 1vw; background-color: #f8f9fa; border-bottom: 3px solid #d90000;">
      <img src="/static/logo.jpg" alt="ZAKA Controls & Devices" style="height: 19vh; width: auto; max-width: 117vw; object-fit: contain;">
  </div>
  
  <div class="container-fluid py-4">
    <div class="row mb-4 text-center">
      <div class="col-12">
        <h2 class="fw-bold mb-0">
          ZAKA Controls &amp; Devices - Packing List
        </h2>
      </div>
    </div>

    <form id="packingForm">
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label fw-semibold">Currency</label>
          <select class="form-select" id="currencySelect">
            <option value="USD" selected>USD ($)</option>
            <option value="INR">INR (₹)</option>
            <option value="EUR">EUR (€)</option>
          </select>
          <input type="hidden" name="currency" id="currencyHidden" value="USD">
        </div>
      </div>
      <div class="card-section">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Consignee Address</label>
            <textarea
              class="form-control border-success"
              rows="3"
              name="consigneeAddress"
              placeholder="Consignee address (3 lines)"
            ></textarea>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Delivery Address</label>
            <textarea
              class="form-control border-success"
              rows="3"
              name="deliveryAddress"
              placeholder="Delivery address (3 lines)"
            ></textarea>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Exporter Address</label>
            <textarea
              class="form-control border-success"
              rows="3"
              name="exporterAddress"
              placeholder="Exporter address (3 lines)"
            ></textarea>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Packing List No</label>
            <input
              type="text"
              class="form-control border-success"
              name="packingListNo"
              value=""
            />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Date</label>
            <input
              type="date"
              class="form-control border-success"
              name="date"
              value=""
            />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">PO Number</label>
            <input
              type="text"
              class="form-control border-success"
              name="poNumber"
              value=""
            />
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-3">
            <label class="form-label fw-semibold">Loading Port</label>
            <input
              type="text"
              class="form-control border-success"
              name="loadingPort"
              value=""
            />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Discharge Port</label>
            <input
              type="text"
              class="form-control border-success"
              name="dischargePort"
              value=""
            />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">HS Code</label>
            <input
              type="text"
              class="form-control border-success"
              name="hsCode"
              value=""
            />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Tax Number</label>
            <input
              type="text"
              class="form-control border-success"
              name="taxNumber"
              value=""
            />
          </div>
        </div>
      </div>

      <div class="card-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">MODULE A: BOX  PACKING DETAILS</h5>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Packing Type</label>
            <select class="form-select" id="packingTypeSelect">
              <option value="A1" selected>Many Boxes  One Material</option>
              <option value="A2">One Box  Many Materials</option>
              <option value="A3">One Box  One Material</option>
            </select>
          </div>
        </div>

        <div class="mt-3" id="moduleAContainer"></div>
      </div>

      <div class="card-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">MODULE B: ITEM NUMBERS  BOX MAPPING</h5>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Mapping Type</label>
            <select class="form-select" id="mappingTypeSelect">
              <option value="B1" selected>Many Item Numbers  One Box</option>
              <option value="B2">One Item Number  Many Boxes</option>
              <option value="B3">One Item Number  One Box</option>
            </select>
          </div>
        </div>

        <div class="mt-3" id="moduleBContainer"></div>
      </div>

      <div class="text-end mt-3">
        <button type="submit" class="btn btn-primary px-5 fw-semibold" style="background-color: #28a745; border-color: #28a745; color: white; font-weight: bold;"> Submit</button>
        <button type="button" class="btn px-5 fw-semibold ms-2" style="background-color: #6c757d; border-color: #6c757d; color: white; font-weight: bold;" onclick="window.history.back()"> Cancel</button>
      </div>
    </form>
  </div>

  <div class="modal fade" id="validationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="validationModalTitle">Validation Error</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="validationModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>

  <script>
    const moduleAContainer = document.getElementById('moduleAContainer');
    const moduleBContainer = document.getElementById('moduleBContainer');
    const packingTypeSelect = document.getElementById('packingTypeSelect');
    const mappingTypeSelect = document.getElementById('mappingTypeSelect');

    const state = {
      moduleAType: 'A1',
      moduleBType: 'B1',
      moduleA: {
        A1: [
          {
            material: {
              description: '',
            },
            boxes: [
              { boxNumber: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' },
            ],
          },
        ],
        A2: { boxNumber: '', materials: [ { description: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' } ] },
        A3: { boxNumber: '', description: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' },
      },
      moduleB: {
        B1: [ { boxNumber: '', itemNumbers: '' } ],
        B2: [ { itemNumber: '', boxNumbers: '' } ],
        B3: { itemNumber: '', boxNumber: '' },
      },
    };

    function renderModuleA() {
      const t = state.moduleAType;

      if (t === 'A1') {
        const a1 = state.moduleA.A1;
        moduleAContainer.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Many Boxes - One Material</div>
            <button type="button" class="btn btn-light btn-add-item px-4" id="addA1SectionBtn">+ Add Material Section</button>
          </div>
          <div class="row g-3" id="a1Sections"></div>
        `;

        const sectionsEl = moduleAContainer.querySelector('#a1Sections');
        a1.forEach((sec, sIdx) => {
          const col = document.createElement('div');
          col.className = 'col-12';
          col.innerHTML = `
            <div class="table-group">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-semibold">Material &amp; Packaging Description</div>
                <div>
                  <button type="button" class="btn btn-light btn-add-item px-4" data-action="addA1Box" data-s="${sIdx}">+ Add Box Row</button>
                  <button type="button" class="btn btn-outline-danger ms-2" data-action="removeA1Section" data-s="${sIdx}">Remove Material Section</button>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-12">
                  <textarea class="form-control border-success" rows="2" data-k="materialDesc" data-s="${sIdx}">${sec.material.description}</textarea>
                </div>
              </div>

              <div class="fw-semibold mt-3 mb-2">Box-wise Quantity, Dimensions &amp; Weights</div>
              <div class="row g-3" id="a1Boxes_${sIdx}"></div>
            </div>
          `;
          sectionsEl.appendChild(col);

          const boxesEl = col.querySelector(`#a1Boxes_${sIdx}`);
          (sec.boxes || []).forEach((r, idx) => {
            const boxCol = document.createElement('div');
            boxCol.className = 'col-12';
            boxCol.innerHTML = `
              <div>
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-2">
                    <label class="form-label fw-semibold">Box Number</label>
                    <input type="text" class="form-control border-success" data-k="boxNumber" data-s="${sIdx}" data-i="${idx}" value="${r.boxNumber}">
                  </div>
                  <div class="col-6 col-md-1">
                    <label class="form-label fw-semibold">Qty</label>
                    <input type="text" class="form-control border-success" data-k="qty" data-s="${sIdx}" data-i="${idx}" value="${r.qty}">
                  </div>
                  <div class="col-4 col-md-1">
                    <label class="form-label fw-semibold">L</label>
                    <input type="text" class="form-control border-success" data-k="l" data-s="${sIdx}" data-i="${idx}" value="${r.l}">
                  </div>
                  <div class="col-4 col-md-1">
                    <label class="form-label fw-semibold">W</label>
                    <input type="text" class="form-control border-success" data-k="w" data-s="${sIdx}" data-i="${idx}" value="${r.w}">
                  </div>
                  <div class="col-4 col-md-1">
                    <label class="form-label fw-semibold">H</label>
                    <input type="text" class="form-control border-success" data-k="h" data-s="${sIdx}" data-i="${idx}" value="${r.h}">
                  </div>
                  <div class="col-6 col-md-1">
                    <label class="form-label fw-semibold">Net</label>
                    <input type="text" class="form-control border-success" data-k="netWt" data-s="${sIdx}" data-i="${idx}" value="${r.netWt}">
                  </div>
                  <div class="col-6 col-md-1">
                    <label class="form-label fw-semibold">Gross</label>
                    <input type="text" class="form-control border-success" data-k="grossWt" data-s="${sIdx}" data-i="${idx}" value="${r.grossWt}">
                  </div>
                  <div class="col-12 text-end mt-2">
                    <button type="button" class="btn btn-outline-danger" data-action="removeA1Box" data-s="${sIdx}" data-index="${idx}">Remove Row</button>
                  </div>
                </div>
              </div>
            `;
            boxesEl.appendChild(boxCol);
          });
        });

        moduleAContainer.querySelector('#addA1SectionBtn').addEventListener('click', () => {
          state.moduleA.A1.push({
            material: { description: '' },
            boxes: [ { boxNumber: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' } ],
          });
          renderModuleA();
        });

        moduleAContainer.querySelectorAll('textarea[data-k="materialDesc"]').forEach((el) => {
          el.addEventListener('input', (e) => {
            const s = Number(e.target.getAttribute('data-s'));
            if (!Number.isNaN(s)) state.moduleA.A1[s].material.description = e.target.value;
          });
        });

        moduleAContainer.querySelectorAll('input[data-k][data-s][data-i]').forEach((el) => {
          el.addEventListener('input', (e) => {
            const s = Number(e.target.getAttribute('data-s'));
            const i = Number(e.target.getAttribute('data-i'));
            const k = e.target.getAttribute('data-k');
            if (!Number.isNaN(s) && !Number.isNaN(i) && k) state.moduleA.A1[s].boxes[i][k] = e.target.value;
          });
        });

        moduleAContainer.querySelectorAll('button[data-action="addA1Box"]').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            const s = Number(e.target.getAttribute('data-s'));
            if (!Number.isNaN(s)) {
              state.moduleA.A1[s].boxes.push({ boxNumber: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' });
              renderModuleA();
            }
          });
        });

        moduleAContainer.querySelectorAll('button[data-action="removeA1Box"]').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            const s = Number(e.target.getAttribute('data-s'));
            const i = Number(e.target.getAttribute('data-index'));
            if (!Number.isNaN(s) && !Number.isNaN(i)) {
              state.moduleA.A1[s].boxes.splice(i, 1);
              if (state.moduleA.A1[s].boxes.length === 0) {
                state.moduleA.A1[s].boxes.push({ boxNumber: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' });
              }
              renderModuleA();
            }
          });
        });

        moduleAContainer.querySelectorAll('button[data-action="removeA1Section"]').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            const s = Number(e.target.getAttribute('data-s'));
            if (!Number.isNaN(s)) {
              state.moduleA.A1.splice(s, 1);
              if (state.moduleA.A1.length === 0) {
                state.moduleA.A1.push({
                  material: { description: '' },
                  boxes: [ { boxNumber: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' } ],
                });
              }
              renderModuleA();
            }
          });
        });

        return;
      }

      if (t === 'A2') {
        const a2 = state.moduleA.A2;
        moduleAContainer.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">One Box - Many Materials</div>
            <button type="button" class="btn btn-light btn-add-item px-4" id="addA2MaterialBtn">+ Add Material Row</button>
          </div>
          <div class="table-group">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-2">
                <label class="form-label fw-semibold">Box Number</label>
                <input type="text" class="form-control border-success" id="a2BoxNumber" value="${a2.boxNumber}">
              </div>
            </div>
            <div class="row g-3 mt-2" id="a2Materials"></div>
          </div>
        `;

        moduleAContainer.querySelector('#a2BoxNumber').addEventListener('input', (e) => (state.moduleA.A2.boxNumber = e.target.value));

        const materialsEl = moduleAContainer.querySelector('#a2Materials');
        a2.materials.forEach((m, idx) => {
          const col = document.createElement('div');
          col.className = 'col-12';
          col.innerHTML = `
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-4">
                <label class="form-label fw-semibold">Material &amp; Packaging Description</label>
                <textarea class="form-control border-success" rows="2" data-i="${idx}" data-k="description">${m.description}</textarea>
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label fw-semibold">Qty</label>
                <input type="text" class="form-control border-success" data-i="${idx}" data-k="qty" value="${m.qty}">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label fw-semibold">L</label>
                <input type="text" class="form-control border-success" data-i="${idx}" data-k="l" value="${m.l}">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label fw-semibold">W</label>
                <input type="text" class="form-control border-success" data-i="${idx}" data-k="w" value="${m.w}">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label fw-semibold">H</label>
                <input type="text" class="form-control border-success" data-i="${idx}" data-k="h" value="${m.h}">
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label fw-semibold">Net</label>
                <input type="text" class="form-control border-success" data-i="${idx}" data-k="netWt" value="${m.netWt}">
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label fw-semibold">Gross</label>
                <input type="text" class="form-control border-success" data-i="${idx}" data-k="grossWt" value="${m.grossWt}">
              </div>
              <div class="col-12 text-end mt-2">
                <button type="button" class="btn btn-outline-danger" data-action="removeA2" data-index="${idx}">Remove Material</button>
              </div>
            </div>
          `;
          materialsEl.appendChild(col);
        });

        moduleAContainer.querySelector('#addA2MaterialBtn').addEventListener('click', () => {
          state.moduleA.A2.materials.push({ description: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' });
          renderModuleA();
        });

        moduleAContainer.querySelectorAll('input[data-k], textarea[data-k]').forEach((el) => {
          el.addEventListener('input', (e) => {
            const i = Number(e.target.getAttribute('data-i'));
            const k = e.target.getAttribute('data-k');
            if (!Number.isNaN(i) && k) state.moduleA.A2.materials[i][k] = e.target.value;
          });
        });

        moduleAContainer.querySelectorAll('button[data-action="removeA2"]').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            const i = Number(e.target.getAttribute('data-index'));
            if (!Number.isNaN(i)) {
              state.moduleA.A2.materials.splice(i, 1);
              if (state.moduleA.A2.materials.length === 0) state.moduleA.A2.materials.push({ description: '', qty: '', l: '', w: '', h: '', netWt: '', grossWt: '' });
              renderModuleA();
            }
          });
        });

        return;
      }

      if (t === 'A3') {
        const a3 = state.moduleA.A3;
        moduleAContainer.innerHTML = `
          <div class="fw-semibold mb-2">One Box - One Material</div>
          <div class="table-group">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-2">
                <label class="form-label fw-semibold">Box Number</label>
                <input type="text" class="form-control border-success" id="a3Box" value="${a3.boxNumber}">
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-semibold">Material &amp; Packaging Description</label>
                <textarea class="form-control border-success" rows="2" id="a3Desc">${a3.description}</textarea>
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label fw-semibold">Qty</label>
                <input type="text" class="form-control border-success" id="a3Qty" value="${a3.qty}">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label fw-semibold">L</label>
                <input type="text" class="form-control border-success" id="a3L" value="${a3.l}">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label fw-semibold">W</label>
                <input type="text" class="form-control border-success" id="a3W" value="${a3.w}">
              </div>
              <div class="col-4 col-md-1">
                <label class="form-label fw-semibold">H</label>
                <input type="text" class="form-control border-success" id="a3H" value="${a3.h}">
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label fw-semibold">Net</label>
                <input type="text" class="form-control border-success" id="a3Net" value="${a3.netWt}">
              </div>
              <div class="col-6 col-md-1">
                <label class="form-label fw-semibold">Gross</label>
                <input type="text" class="form-control border-success" id="a3Gross" value="${a3.grossWt}">
              </div>
            </div>
          </div>
        `;

        moduleAContainer.querySelector('#a3Box').addEventListener('input', (e) => (state.moduleA.A3.boxNumber = e.target.value));
        moduleAContainer.querySelector('#a3Desc').addEventListener('input', (e) => (state.moduleA.A3.description = e.target.value));
        moduleAContainer.querySelector('#a3Qty').addEventListener('input', (e) => (state.moduleA.A3.qty = e.target.value));
        moduleAContainer.querySelector('#a3L').addEventListener('input', (e) => (state.moduleA.A3.l = e.target.value));
        moduleAContainer.querySelector('#a3W').addEventListener('input', (e) => (state.moduleA.A3.w = e.target.value));
        moduleAContainer.querySelector('#a3H').addEventListener('input', (e) => (state.moduleA.A3.h = e.target.value));
        moduleAContainer.querySelector('#a3Net').addEventListener('input', (e) => (state.moduleA.A3.netWt = e.target.value));
        moduleAContainer.querySelector('#a3Gross').addEventListener('input', (e) => (state.moduleA.A3.grossWt = e.target.value));
      }
    }

    function renderModuleB() {
      const t = state.moduleBType;

      if (t === 'B1') {
        moduleBContainer.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Many Item Numbers - One Box</div>
            <button type="button" class="btn btn-light btn-add-item px-4" id="addB1RowBtn">+ Add Row</button>
          </div>
          <div class="row g-3" id="b1Rows"></div>
        `;

        const rowsEl = moduleBContainer.querySelector('#b1Rows');
        state.moduleB.B1.forEach((r, idx) => {
          const col = document.createElement('div');
          col.className = 'col-12';
          col.innerHTML = `
            <div class="table-group">
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-2">
                  <label class="form-label fw-semibold">Box Number</label>
                  <input type="text" class="form-control border-success" data-i="${idx}" data-k="boxNumber" value="${r.boxNumber}">
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label fw-semibold">Item Numbers</label>
                  <input type="text" class="form-control border-success" data-i="${idx}" data-k="itemNumbers" value="${r.itemNumbers}">
                </div>
                <div class="col-12 col-md-4 text-end">
                  <button type="button" class="btn btn-outline-danger" data-action="removeB1" data-index="${idx}">Remove Row</button>
                </div>
              </div>
            </div>
          `;
          rowsEl.appendChild(col);
        });

        moduleBContainer.querySelector('#addB1RowBtn').addEventListener('click', () => {
          state.moduleB.B1.push({ boxNumber: '', itemNumbers: '' });
          renderModuleB();
        });

        moduleBContainer.querySelectorAll('input[data-k]').forEach((el) => {
          el.addEventListener('input', (e) => {
            const i = Number(e.target.getAttribute('data-i'));
            const k = e.target.getAttribute('data-k');
            if (!Number.isNaN(i) && k) state.moduleB.B1[i][k] = e.target.value;
          });
        });

        moduleBContainer.querySelectorAll('button[data-action="removeB1"]').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            const i = Number(e.target.getAttribute('data-index'));
            if (!Number.isNaN(i)) {
              state.moduleB.B1.splice(i, 1);
              if (state.moduleB.B1.length === 0) state.moduleB.B1.push({ boxNumber: '', itemNumbers: '' });
              renderModuleB();
            }
          });
        });

        return;
      }

      if (t === 'B2') {
        moduleBContainer.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">One Item Number - Many Boxes</div>
            <button type="button" class="btn btn-light btn-add-item px-4" id="addB2RowBtn">+ Add Row</button>
          </div>
          <div class="row g-3" id="b2Rows"></div>
        `;

        const rowsEl = moduleBContainer.querySelector('#b2Rows');
        state.moduleB.B2.forEach((r, idx) => {
          const col = document.createElement('div');
          col.className = 'col-12';
          col.innerHTML = `
            <div class="table-group">
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-2">
                  <label class="form-label fw-semibold">Item Number</label>
                  <input type="text" class="form-control border-success" data-i="${idx}" data-k="itemNumber" value="${r.itemNumber}">
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label fw-semibold">Box Numbers</label>
                  <input type="text" class="form-control border-success" data-i="${idx}" data-k="boxNumbers" value="${r.boxNumbers}">
                </div>
                <div class="col-12 col-md-4 text-end">
                  <button type="button" class="btn btn-outline-danger" data-action="removeB2" data-index="${idx}">Remove Row</button>
                </div>
              </div>
            </div>
          `;
          rowsEl.appendChild(col);
        });

        moduleBContainer.querySelector('#addB2RowBtn').addEventListener('click', () => {
          state.moduleB.B2.push({ itemNumber: '', boxNumbers: '' });
          renderModuleB();
        });

        moduleBContainer.querySelectorAll('input[data-k]').forEach((el) => {
          el.addEventListener('input', (e) => {
            const i = Number(e.target.getAttribute('data-i'));
            const k = e.target.getAttribute('data-k');
            if (!Number.isNaN(i) && k) state.moduleB.B2[i][k] = e.target.value;
          });
        });

        moduleBContainer.querySelectorAll('button[data-action="removeB2"]').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            const i = Number(e.target.getAttribute('data-index'));
            if (!Number.isNaN(i)) {
              state.moduleB.B2.splice(i, 1);
              if (state.moduleB.B2.length === 0) state.moduleB.B2.push({ itemNumber: '', boxNumbers: '' });
              renderModuleB();
            }
          });
        });

        return;
      }

      if (t === 'B3') {
        const b3 = state.moduleB.B3;
        moduleBContainer.innerHTML = `
          <div class="fw-semibold mb-2">One Item Number - One Box</div>
          <div class="table-group">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-2">
                <label class="form-label fw-semibold">Item Number</label>
                <input type="text" class="form-control border-success" id="b3Item" value="${b3.itemNumber}">
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label fw-semibold">Box Number</label>
                <input type="text" class="form-control border-success" id="b3Box" value="${b3.boxNumber}">
              </div>
            </div>
          </div>
        `;

        moduleBContainer.querySelector('#b3Item').addEventListener('input', (e) => (state.moduleB.B3.itemNumber = e.target.value));
        moduleBContainer.querySelector('#b3Box').addEventListener('input', (e) => (state.moduleB.B3.boxNumber = e.target.value));
      }
    }

    function showValidationModal(title, htmlBody) {
      const titleEl = document.getElementById('validationModalTitle');
      const bodyEl = document.getElementById('validationModalBody');
      if (titleEl) titleEl.textContent = title || 'Validation Error';
      if (bodyEl) bodyEl.innerHTML = htmlBody || '';

      const el = document.getElementById('validationModal');
      if (!el) {
        alert((title || 'Validation Error') + "\n" + (bodyEl ? bodyEl.textContent : ''));
        return;
      }
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      modal.show();
    }

    function parseNumberTokens(input) {
      const raw = String(input ?? '').trim();
      if (!raw) return [];

      const out = [];
      for (const token of raw.split(',')) {
        const t = token.trim();
        if (!t) continue;
        out.push(t);
      }
      return out;
    }

    function collectModuleABoxNumbers() {
      const set = new Set();
      if (state.moduleAType === 'A1') {
        for (const sec of state.moduleA.A1) {
          for (const r of (sec.boxes || [])) {
            for (const b of parseNumberTokens(r.boxNumber)) set.add(String(b).trim());
          }
        }
      } else if (state.moduleAType === 'A2') {
        for (const b of parseNumberTokens(state.moduleA.A2.boxNumber)) set.add(String(b).trim());
      } else if (state.moduleAType === 'A3') {
        for (const b of parseNumberTokens(state.moduleA.A3.boxNumber)) set.add(String(b).trim());
      }
      return set;
    }

    function collectModuleBBoxNumbers() {
      const set = new Set();
      if (state.moduleBType === 'B1') {
        for (const r of state.moduleB.B1) {
          for (const b of parseNumberTokens(r.boxNumber)) set.add(String(b).trim());
        }
      } else if (state.moduleBType === 'B2') {
        for (const r of state.moduleB.B2) {
          for (const b of parseNumberTokens(r.boxNumbers)) set.add(String(b).trim());
        }
      } else if (state.moduleBType === 'B3') {
        for (const b of parseNumberTokens(state.moduleB.B3.boxNumber)) set.add(String(b).trim());
      }
      return set;
    }

    function validateModuleBBoxExistInA() {
      const aBoxes = collectModuleABoxNumbers();
      const bBoxes = collectModuleBBoxNumbers();

      const missing = [];
      for (const b of bBoxes) {
        if (b && !aBoxes.has(b)) missing.push(b);
      }
      missing.sort((x, y) => {
        const xi = Number(x);
        const yi = Number(y);
        if (!Number.isNaN(xi) && !Number.isNaN(yi)) return xi - yi;
        return String(x).localeCompare(String(y));
      });

      if (missing.length > 0) {
        showValidationModal(
          'Missing Box Numbers',
          `<div class="fw-semibold mb-2">Module B references Box Number(s) that are not available / not inserted in Module A.</div>
           <div class="mb-2">Please add these box numbers in Module A, then submit again.</div>
           <div><b>Missing:</b> ${missing.join(', ')}</div>`
        );
        return false;
      }
      return true;
    }

    packingTypeSelect.addEventListener('change', (e) => {
      state.moduleAType = e.target.value;
      renderModuleA();
    });

    mappingTypeSelect.addEventListener('change', (e) => {
      state.moduleBType = e.target.value;
      renderModuleB();
    });

    document.getElementById('packingForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const moduleAForPayload =
        state.moduleAType === 'A1'
          ? state.moduleA.A1.flatMap((sec) =>
              (sec.boxes || []).map((b) => ({
                boxNumbers: b.boxNumber,
                description: (sec.material && sec.material.description) || '',
                qty: b.qty,
                l: b.l,
                w: b.w,
                h: b.h,
                netWt: b.netWt,
                grossWt: b.grossWt,
              }))
            )
          : state.moduleA[state.moduleAType];
      const payload = {
        consigneeAddress: formData.get('consigneeAddress'),
        deliveryAddress: formData.get('deliveryAddress'),
        exporterAddress: formData.get('exporterAddress'),
        packingListNo: formData.get('packingListNo'),
        date: formData.get('date'),
        poNumber: formData.get('poNumber'),
        loadingPort: formData.get('loadingPort'),
        dischargePort: formData.get('dischargePort'),
        hsCode: formData.get('hsCode'),
        taxNumber: formData.get('taxNumber'),
        currency: document.getElementById('currencySelect').value,
        moduleAType: state.moduleAType,
        moduleA: moduleAForPayload,
        moduleBType: state.moduleBType,
        moduleB: state.moduleB[state.moduleBType],
      };

      const isEmpty = (v) => !String(v ?? '').trim();

      if (state.moduleAType === 'A1') {
        for (const sec of state.moduleA.A1) {
          if (isEmpty(sec?.material?.description)) {
            alert('Module A: Material & Packaging Description cannot be empty.');
            return;
          }
          if (!sec.boxes || sec.boxes.length === 0) {
            alert('Module A: At least one box row must exist under each material section.');
            return;
          }
          for (const r of sec.boxes) {
            if (isEmpty(r.boxNumber)) {
              alert('Module A: Box Number cannot be empty.');
              return;
            }
          }
        }
      }

      if (state.moduleAType === 'A2') {
        if (isEmpty(state.moduleA.A2.boxNumber)) {
          alert('Module A: Box Number cannot be empty.');
          return;
        }
        for (const m of state.moduleA.A2.materials) {
          if (isEmpty(m.description)) {
            alert('Module A: Material Description cannot be empty.');
            return;
          }
        }
      }

      if (state.moduleAType === 'A3') {
        const a3 = state.moduleA.A3;
        if (isEmpty(a3.boxNumber) || isEmpty(a3.description)) {
          alert('Module A: Box Number and Description cannot be empty.');
          return;
        }
      }

      if (state.moduleBType === 'B1') {
        for (const r of state.moduleB.B1) {
          if (isEmpty(r.boxNumber) || isEmpty(r.itemNumbers)) {
            alert('Module B: Box Number and Item Numbers cannot be empty.');
            return;
          }
        }
      }

      if (state.moduleBType === 'B2') {
        for (const r of state.moduleB.B2) {
          if (isEmpty(r.itemNumber) || isEmpty(r.boxNumbers)) {
            alert('Module B: Item Number and Box Numbers cannot be empty.');
            return;
          }
        }
      }

      if (state.moduleBType === 'B3') {
        const b3 = state.moduleB.B3;
        if (isEmpty(b3.itemNumber) || isEmpty(b3.boxNumber)) {
          alert('Module B: Item Number and Box Number cannot be empty.');
          return;
        }
      }

      if (!validateModuleBBoxExistInA()) return;

      fetch('/api/packaging-list/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })
        .then(async (res) => {
          const json = await res.json().catch(() => ({}));
          if (!res.ok || !json.success) {
            const msg = (json && (json.message || json.error)) || 'Failed to save packing list.';
            showValidationModal('Save Failed', `<div>${String(msg)}</div>`);
            return;
          }
          if (json.id) {
            window.location.href = `/packaging_list/print/${json.id}`;
            return;
          }
          showValidationModal('Saved', '<div>Packing list saved successfully.</div>');
        })
        .catch((err) => {
          showValidationModal('Save Failed', `<div>${String(err || 'Network error')}</div>`);
        });
    });

    renderModuleA();
    renderModuleB();
    // sync currency selection to hidden input
    const currencySelectElem = document.getElementById('currencySelect');
    if (currencySelectElem) {
      const currencyHidden = document.getElementById('currencyHidden');
      currencySelectElem.addEventListener('change', (e) => {
        if (currencyHidden) currencyHidden.value = e.target.value;
      });
    }
  </script>
</body>
</html>