<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAKA Proforma Invoice - Add</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* [CSS from previous response remains here for layout integrity] */
        /* --- 1. General & Container Styling --- */
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1100px;
            padding: 30px 20px;
            background-color: #ffffff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        /* --- 2. Header & Logo Styling --- */
        .header-section {
            text-align: center;
            margin-bottom: 25px;
        }
        .logo-box {
            border: 2px solid #000;
            display: inline-block;
            padding: 3px 15px;
            margin-bottom: 5px;
        }
        .logo-text {
            color: #d90000;
            font-weight: bold;
            font-size: 1.4rem;
            line-height: 1;
        }
        .subtitle {
            font-size: 0.8rem;
            color: #333;
            line-height: 1;
            letter-spacing: 0.5px;
        }
        .invoice-title {
            font-size: 1.7rem;
            font-weight: 500;
            margin-top: 5px;
        }
        
        /* --- 3. Form Input Consistency --- */
        .form-control, .form-select, .form-input-table {
            border-radius: 0;
            padding: 0.3rem 0.6rem;
            font-size: 0.95rem;
            border-color: #ced4da;
        }
        .form-label {
            font-weight: bold;
            margin-bottom: 0.2rem;
            font-size: 1.1rem;
            color: #000;
        }
        .form-control[readonly] {
            background-color: #fff;
        }

        /* --- 4. Main Section Border Styling --- */
        .address-box, .table-box, .summary-box, .discharge-box {
            border: 2px solid #000;
            padding: 15px;
            margin-bottom: 25px;
        }
        .address-box textarea {
            height: 100px;
            resize: none;
        }

        /* --- 5. Line Item Table Styling --- */
        .line-item-table {
            width: 100%;
            border-collapse: collapse;
        }
        .line-item-table th, .line-item-table td {
            border: 1px solid #dee2e6;
            padding: 0;
            vertical-align: middle;
        }
        .line-item-table th {
            padding: 8px;
            background-color: #f1f1f1;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .line-item-table td input[type="text"],
        .line-item-table td input[type="number"] {
            width: 100%;
            height: 100%;
            border: none;
            padding: 0.3rem 0.6rem;
            box-shadow: none; 
            background-color: transparent;
        }
        .line-item-table td:first-child {
            text-align: center;
            font-weight: bold;
            padding: 0.3rem 0.6rem;
            background-color: #f9f9f9;
        }
        .line-item-table th:nth-child(1) { width: 5%; }
        .line-item-table th:nth-child(2) { width: 15%; }
        .line-item-table th:nth-child(3) { width: 35%; }
        .line-item-table th:nth-child(4), .line-item-table th:nth-child(5) { width: 10%; }
        .line-item-table th:nth-child(6) { width: 15%; }


        /* --- 6. Add Row Button Styling --- */
        .add-row-controls {
            padding-top: 5px;
            font-size: 0.9rem;
        }
        .add-row-controls .btn {
            background-color: #0d6efd;
            border-color: #0d6efd;
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
        }

        /* --- 7. Summary Box Field Layout --- */
        .summary-box .col-md-4 {
            padding-left: 5px;
            padding-right: 5px;
        }
        .summary-box .row {
            --bs-gutter-x: 0;
            margin-bottom: 10px;
        }

        /* --- 8. Submit Button --- */
        .submit-btn-container {
            margin-top: 30px;
        }
    </style>
</head>
<body>

<!-- Logo Header -->
  <div style="text-align: center; padding: 2vh 1vw; background-color: #f8f9fa; border-bottom: 3px solid #d90000;">
      <img src="/static/logo.jpg" alt="ZAKA Controls & Devices" style="height: 19vh; width: auto; max-width: 117vw; object-fit: contain;">
  </div><div class="container">
    <div class="header-section">
        <div class="invoice-title">Proforma Invoice</div>
    </div>
    
    
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <label for="invoiceDate" class="form-label">Invoice Date</label>
            <input type="date" class="form-control" id="invoiceDate" value="2025-12-07">
        </div>
        <div class="col-md-3">
            <label for="invoiceNo" class="form-label">Invoice No</label>
            <input type="text" class="form-control" id="invoiceNo" value="PI-2025-001">
        </div>
        <div class="col-md-2">
            <label for="poWoNumber" class="form-label">PO/WO Number</label>
            <input type="text" class="form-control" id="poWoNumber" value="PO-2025-0001">
        </div>
        <div class="col-md-2">
            <label for="yourRefNo" class="form-label">Our Reference No</label>
            <input type="text" class="form-control" id="yourRefNo" value="REF-ZAKA-001">
        </div>
        <div class="col-md-2">
            <label for="yourReferenceNo" class="form-label">Your Reference No</label>
            <input type="text" class="form-control" id="yourReferenceNo" placeholder="">
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 address-box me-0">
            <label for="supplierAddress" class="form-label">Supplier Address</label>
            <textarea class="form-control" id="supplierAddress" rows="4">ZAKA Controls & Devices
P.O. Box 12345
Dubai, UAE</textarea>
        </div>
        <div class="col-md-6 address-box ms-0">
            <label for="billToAddress" class="form-label">Bill To Address</label>
            <textarea class="form-control" id="billToAddress" rows="4">ABC Trading Company
123 Business Street
Rotterdam, Netherlands</textarea>
        </div>
    </div>

    <div class="table-box">
        <div class="table-responsive">
            <table class="line-item-table">
                <thead>
                    <tr>
                        <th scope="col">Line No</th>
                        <th scope="col">Part Number</th>
                        <th scope="col">Description</th>
                        <th scope="col" class="text-end">Quantity</th>
                        <th scope="col" class="text-end">Unit Rate</th>
                        <th scope="col" class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody id="lineItemsBody">
                    <tr class="line-item-row" data-line="1">
                        <td class="line-no">1</td>
                        <td><input type="text" class="form-input-table part-number" value=""></td>
                        <td><input type="text" class="form-input-table description" value=""></td>
                        <td><input type="number" class="form-input-table quantity text-end" value="0"></td>
                        <td>
                            <div class="d-flex justify-content-end align-items-center">
                                <input type="number" class="form-input-table unit-rate text-end" value="0.00">
                                <span class="currency-display ms-2" style="min-width: 15px;"></span>
                            </div>
                        </td>
                        <td class="total text-end pe-3"><span class="amount-num">0.00</span><span class="currency-display ms-2" style="min-width: 15px;"></span></td>
                    </tr>
                    <tr class="line-item-row" data-line="2">
                        <td class="line-no">2</td>
                        <td><input type="text" class="form-input-table part-number" value=""></td>
                        <td><input type="text" class="form-input-table description" value=""></td>
                        <td><input type="number" class="form-input-table quantity text-end" value="0"></td>
                        <td>
                            <div class="d-flex justify-content-end align-items-center">
                                <input type="number" class="form-input-table unit-rate text-end" value="0.00">
                                <span class="currency-display ms-2" style="min-width: 15px;"></span>
                            </div>
                        </td>
                        <td class="total text-end pe-3"><span class="amount-num">0.00</span><span class="currency-display ms-2" style="min-width: 15px;"></span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="d-flex align-items-center add-row-controls">
            <span class="me-2">Add a new line item:</span>
            <button type="button" class="btn btn-primary" id="addRowBtn" style="background-color: #0d6efd; border-color: #0d6efd; color: white; font-weight: bold;">➕ Add Row</button>
        </div>
    </div>

    <div class="summary-box">
        <div class="row">
            <div class="col-md-4">
                <label for="totalAmount" class="form-label">Total Amount</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="totalAmount" value="0.00" readonly>
                    <span class="input-group-text currency-display"></span>
                </div>
            </div>
            <div class="col-md-4">
                <label for="currencySelect" class="form-label">Currency</label>
                <select class="form-select" id="currencySelect">
                    <option value="USD" selected>USD ($)</option>
                    <option value="INR">INR (₹)</option>
                    <option value="EUR">EUR (€)</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="discountPercentage" class="form-label">Discount (%)</label>
                <input type="number" class="form-control" id="discountPercentage" value="5">
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <label for="discountAmount" class="form-label">Discount Amount</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="discountAmount" value="0.00" readonly>
                    <span class="input-group-text currency-display"></span>
                </div>
            </div>
            <div class="col-md-4">
                <label for="receivableAmount" class="form-label">Receivable Amount</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="receivableAmount" readonly>
                    <span class="input-group-text currency-display"></span>
                </div>
            </div>
            <div class="col-md-4">
                <label for="receivedAmount" class="form-label">Received Amount</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="receivedAmount" placeholder="e.g., 5000.00">
                    <span class="input-group-text currency-display"></span>
                </div>
            </div>
        </div>

        <div class="row mb-0">
            <div class="col-md-4">
                <label for="balanceAmount" class="form-label">Balance Amount</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="balanceAmount" value="0.00" readonly>
                    <span class="input-group-text currency-display"></span>
                </div>
            </div>
            <div class="col-md-4">
                <label for="countryOfOrigin" class="form-label">Country of Origin</label>
                <input type="text" class="form-control" id="countryOfOrigin" value="United Arab Emirates">
            </div>
            <div class="col-md-4">
                <label for="portOfEmbarkation" class="form-label">Port of Embarkation</label>
                <input type="text" class="form-control" id="portOfEmbarkation" value="Jebel Ali Port">
            </div>
        </div>
    </div>

    <div class="discharge-box mb-4">
        <div class="row">
            <div class="col-12">
                <label for="portOfDischarge" class="form-label">Port of Discharge</label>
                <input type="text" class="form-control" id="portOfDischarge" value="Rotterdam Port">
            </div>
        </div>
    </div>

    <div class="text-center submit-btn-container">
        <button type="button" class="btn btn-primary btn-lg" id="submitBtn" style="width: 200px; background-color: #28a745; border-color: #28a745; color: white; font-weight: bold;">✓ Submit</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const lineItemsBody = document.getElementById('lineItemsBody');
        const addRowBtn = document.getElementById('addRowBtn');
        const totalAmountInput = document.getElementById('totalAmount');
        const discountPercentageInput = document.getElementById('discountPercentage');
        const discountAmountInput = document.getElementById('discountAmount');
        const receivableAmountInput = document.getElementById('receivableAmount');
        const balanceAmountInput = document.getElementById('balanceAmount');
        const currencySelect = document.getElementById('currencySelect');

        const currencySymbolMap = {
            USD: '$',
            INR: '₹',
            EUR: '€'
        };

        function updateCurrencySymbols() {
            const symbol = currencySymbolMap[currencySelect.value] || '';
            document.querySelectorAll('.currency-display').forEach(el => el.textContent = symbol);
        }
        currencySelect.addEventListener('change', updateCurrencySymbols);

        // Function to create a new line item row HTML string
        const createRow = (lineNumber) => {
            return `
                <tr class="line-item-row" data-line="${lineNumber}">
                    <td class="line-no">${lineNumber}</td>
                    <td><input type="text" class="form-input-table part-number" value=""></td>
                    <td><input type="text" class="form-input-table description" value=""></td>
                    <td><input type="number" class="form-input-table quantity text-end" value="0" min="0"></td>
                    <td>
                        <div class="d-flex justify-content-end align-items-center">
                            <input type="number" class="form-input-table unit-rate text-end" value="0.00" min="0" step="0.01">
                            <span class="currency-display ms-2" style="min-width: 15px;"></span>
                        </div>
                    </td>
                    <td class="total text-end pe-3"><span class="amount-num">0.00</span><span class="currency-display ms-2" style="min-width: 15px;"></span></td>
                </tr>
            `;
        };

        // Function to calculate total for a single row
        const calculateLineTotal = (row) => {
            const quantityInput = row.querySelector('.quantity');
            const unitRateInput = row.querySelector('.unit-rate');
            const totalCell = row.querySelector('.total');

            const quantity = parseFloat(quantityInput.value) || 0;
            const rate = parseFloat(unitRateInput.value) || 0;
            
            const lineTotal = quantity * rate;
            
            const amountSpan = totalCell.querySelector('.amount-num');
            if (amountSpan) {
                amountSpan.textContent = lineTotal.toFixed(2);
            } else {
                totalCell.textContent = lineTotal.toFixed(2);
            }
            return lineTotal;
        };

        // Function to calculate all summary amounts
        const updateSummary = () => {
            let grandTotal = 0;
            const rows = lineItemsBody.querySelectorAll('.line-item-row');
            
            rows.forEach(row => {
                grandTotal += calculateLineTotal(row);
            });

            // 1. Total Amount
            totalAmountInput.value = grandTotal.toFixed(2);

            // 2. Discount Amount
            const discountPercent = parseFloat(discountPercentageInput.value) || 0;
            const discountAmount = grandTotal * (discountPercent / 100);
            discountAmountInput.value = discountAmount.toFixed(2);

            // 3. Subtotal after Discount
            const subTotal = grandTotal - discountAmount;

            // 4. Receivable Amount (50%)
            const receivableAmount = subTotal * 0.50;
            receivableAmountInput.value = receivableAmount.toFixed(2);

            // 5. Balance Amount (Assuming Received Amount is 0 for initial calculation)
            // Note: If Received Amount were dynamic, we would subtract it here.
            // Since it's fixed at "zero dollars", the balance is the subtotal.
            balanceAmountInput.value = subTotal.toFixed(2);
        };

        // Function to handle row input changes and re-run calculations
        const handleInputChange = (event) => {
            // Check if the change is in a Quantity or Unit Rate input field
            if (event.target.classList.contains('quantity') || event.target.classList.contains('unit-rate')) {
                const row = event.target.closest('.line-item-row');
                calculateLineTotal(row);
            }
            updateSummary();
        };

        // Event listener for adding new rows
        addRowBtn.addEventListener('click', () => {
            const currentRowCount = lineItemsBody.querySelectorAll('.line-item-row').length;
            const newRowNumber = currentRowCount + 1;
            
            lineItemsBody.insertAdjacentHTML('beforeend', createRow(newRowNumber));
            
            // Re-attach event listeners to all newly added inputs
            lineItemsBody.lastElementChild.querySelectorAll('.form-input-table').forEach(input => {
                input.addEventListener('input', handleInputChange);
            });

            // Ensure currency symbol is applied to newly added row
            updateCurrencySymbols();

            updateSummary(); // Re-calculate after adding a row
        });

        // Event listeners for calculating on input changes in the table and discount fields
        lineItemsBody.addEventListener('input', handleInputChange);
        discountPercentageInput.addEventListener('input', updateSummary);

        // Submit button handler
        document.getElementById('submitBtn').addEventListener('click', () => {
            // Gather all form data
            const formData = {
                invoiceDate: document.getElementById('invoiceDate').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                poWoNumber: document.getElementById('poWoNumber').value,
                yourRefNo: document.getElementById('yourRefNo').value,
                yourReferenceNo: document.getElementById('yourReferenceNo').value,
                supplierAddress: document.getElementById('supplierAddress').value,
                billToAddress: document.getElementById('billToAddress').value,
                lineItems: [],
                totalAmount: document.getElementById('totalAmount').value,
                currency: document.getElementById('currencySelect').value,
                discountPercentage: document.getElementById('discountPercentage').value,
                discountAmount: document.getElementById('discountAmount').value,
                receivableAmount: document.getElementById('receivableAmount').value,
                receivedAmount: document.getElementById('receivedAmount').value,
                balanceAmount: document.getElementById('balanceAmount').value,
                countryOfOrigin: document.getElementById('countryOfOrigin').value,
                portOfEmbarkation: document.getElementById('portOfEmbarkation').value,
                portOfDischarge: document.getElementById('portOfDischarge').value
            };

            // Collect all line items
            const rows = lineItemsBody.querySelectorAll('.line-item-row');
            rows.forEach((row, index) => {
                const lineItem = {
                    lineNo: index + 1,
                    partNumber: row.querySelector('.part-number').value,
                    description: row.querySelector('.description').value,
                    quantity: row.querySelector('.quantity').value,
                    unitRate: row.querySelector('.unit-rate').value,
                    total: (row.querySelector('.total .amount-num') ? row.querySelector('.total .amount-num').textContent : row.querySelector('.total').textContent)
                };
                formData.lineItems.push(lineItem);
            });

            // Send data to server
            fetch('/api/proforma-invoice/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Proforma invoice created successfully!');
                    // Redirect to view page
                    window.location.href = '/proforma_invoice/view';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error submitting form: ' + error);
                console.error('Error:', error);
            });
        });

        // Initial calculation on page load
        updateSummary(); 
        // Apply currency symbols to all display areas
        updateCurrencySymbols();
    });
</script>

</body>
</html>