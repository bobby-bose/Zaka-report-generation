<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZC/IN-07 - Edit Export Invoice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .logo-img {
            max-width: 150px;
        }
        .form-row-padding {
            padding-top: 10px;
        }
        .page-title {
            color: #d90000;
            font-family: 'Times New Roman', Times, serif;
            font-weight: bold;
            font-size: xx-large;
        }
        .auto-expand {
            overflow: hidden;
            resize: none;
            min-height: calc(1.5em * 5 + 0.75rem);
        }
    </style>
</head>
<body>
    <!-- Logo Header -->
  <div style="text-align: center; padding: 2vh 1vw; background-color: #f8f9fa; border-bottom: 3px solid #d90000;">
      <img src="/static/logo.jpg" alt="ZAKA Controls & Devices" style="height: 19vh; width: auto; max-width: 117vw; object-fit: contain;">
  </div>    <div class="container py-4">
        <header class="text-center mb-4">
              <h1 class="h4 page-title">Edit Details Below.</h1>
        </header>

        <form id="exportInvoiceForm" class="p-3 border rounded shadow-sm bg-white">
            
            <fieldset class="mb-4 p-3 border rounded">
                <legend class="float-none w-auto px-1 fs-6">Invoice Details</legend>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="invoiceNumber" class="form-label">Invoice Number</label>
                        <div class="input-group">
                            <span class="input-group-text">ZC/IN/</span>
                            <input type="text" class="form-control" id="invoiceNumber" placeholder="Enter remaining part">
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="invoiceDate" class="form-label">Invoice Date</label>
                        <input type="date" class="form-control" id="invoiceDate">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="buyerOrderNumber" class="form-label">Buyer's Order Number</label>
                        <input type="text" class="form-control" id="buyerOrderNumber">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="buyerOrderDate" class="form-label">Buyer's Order Date</label>
                        <input type="date" class="form-control" id="buyerOrderDate">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="exporterReference" class="form-label">Exporter's Reference</label>
                        <input type="text" class="form-control" id="exporterReference">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="iecNumber" class="form-label">IEC Number</label>
                        <input type="text" class="form-control" id="iecNumber">
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-4 p-3 border rounded">
                <legend class="float-none w-auto px-1 fs-6">Tax and Shipment Details</legend>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="taxRegistrationNumber" class="form-label">Tax Registration Number</label>
                        <input type="text" class="form-control" id="taxRegistrationNumber">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="lutArnNumber" class="form-label">LUT / ARN Number</label>
                        <input type="text" class="form-control" id="lutArnNumber" placeholder="LUT / ARN Number">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="deliveryPaymentTerms" class="form-label">Terms of Delivery & Payment</label>
                        <input type="text" class="form-control" id="deliveryPaymentTerms" placeholder="Terms of delivery & payment">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3"><label for="portOfLoading" class="form-label">Port of Loading</label><input type="text" class="form-control" id="portOfLoading" placeholder="Port of Loading"></div>
                    <div class="col-md-4 mb-3"><label for="portOfDischarge" class="form-label">Port of Discharge</label><input type="text" class="form-control" id="portOfDischarge" placeholder="Port of Discharge"></div>
                    <div class="col-md-4 mb-3"><label for="preCarriageBy" class="form-label">Pre-Carriage By</label><input type="text" class="form-control" id="preCarriageBy" placeholder="Pre-Carriage By"></div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3"><label for="placeOfReceipt" class="form-label">Place of Receipt</label><input type="text" class="form-control" id="placeOfReceipt" placeholder="Place of Receipt"></div>
                    <div class="col-md-4 mb-3"><label for="portOfDestination" class="form-label">Port of Destination</label><input type="text" class="form-control" id="portOfDestination" placeholder="Port of Destination"></div>
                    <div class="col-md-4 mb-3"><label for="destination" class="form-label">Destination</label><input type="text" class="form-control" id="destination" placeholder="Destination"></div>
                </div>
            </fieldset>

            <fieldset class="mb-4 p-3 border rounded">
                <legend class="float-none w-auto px-1 fs-6">Goods and Contact Information</legend>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="currencySelect" class="form-label">Currency</label>
                        <select class="form-select" id="currencySelect">
                            <option value="USD">USD ($)</option>
                            <option value="INR">INR (‚Çπ)</option>
                            <option value="EUR" selected>EUR (‚Ç¨)</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3"><label for="vesselFlight" class="form-label">Vessel / Flight</label><input type="text" class="form-control" id="vesselFlight" placeholder="Vessel / Flight"></div>
                    <div class="col-md-4 mb-3"><label for="countryOfOrigin" class="form-label">Country of Origin (Goods)</label><input type="text" class="form-control" id="countryOfOrigin" placeholder="Country of Origin (Goods)"></div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3"><label for="adCode" class="form-label">AD Code</label><input type="text" class="form-control" id="adCode" placeholder="Enter AD Code"></div>
                    <div class="col-md-4 mb-3"><label for="otherReference" class="form-label">Other Reference</label><input type="text" class="form-control" id="otherReference"></div>
                    <div class="col-md-4 mb-3"><label for="hsCode" class="form-label">HS Code</label><input type="text" class="form-control" id="hsCode" placeholder="HS Code (eg. 8471.80)"></div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3"><label for="finalDestination" class="form-label">Final Destination</label><input type="text" class="form-control" id="finalDestination" placeholder="Final Destination"></div>
                    <div class="col-md-4 mb-3"><label for="contactPersonName" class="form-label">Contact Person Name</label><input type="text" class="form-control" id="contactPersonName"></div>
                    <div class="col-md-4 mb-3"><label for="contactEmail" class="form-label">Contact Email</label><input type="email" class="form-control" id="contactEmail"></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label for="consigneeAddress" class="form-label">Consignee Address</label><textarea class="form-control auto-expand" id="consigneeAddress" rows="5"></textarea></div>
                    <div class="col-md-6 mb-3"><label for="deliveryAddress" class="form-label">Delivery Address</label><textarea class="form-control auto-expand" id="deliveryAddress" rows="5"></textarea></div>
                </div>
            </fieldset>

            <h4 class="mt-4">Table: Number & Kind of Pkgs.</h4>
            <div class="d-flex mb-3">
                <button type="button" class="btn btn-primary btn-sm me-2" id="addRowBtn" style="background-color: #0d6efd; border-color: #0d6efd; color: white; font-weight: bold;">‚ûï Add Row</button>
                <button type="button" class="btn btn-sm" id="removeRowBtn" style="background-color: #dc3545; border-color: #dc3545; color: white; font-weight: bold;">‚ûñ Remove Row</button>
            </div>
            
            <div class="table-responsive mb-4">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 6%;">From</th>
                            <th style="width: 6%;">To</th>
                            <th style="width: 20%;">Description</th>
                            <th style="width: 8%;">Unit</th>
                            <th style="width: 8%;">Quantity</th>
                            <th style="width: 8%;">Rate</th>
                            <th style="width: 10%;">Amount</th>
                            <th style="width: 10%;">Taxable Value</th>
                            <th style="width: 8%;">IGST %</th>
                            <th style="width: 10%;">IGST Amount</th>
                            <th style="width: 6%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemDetailsContainer">
                    </tbody>
                </table>
            </div>

            <div class="row pt-3 border-top">
                <div class="col-12 mb-3">
                    <div class="input-group">
                        <span class="input-group-text">Amount in Words:</span>
                        <input type="text" class="form-control" id="amountInWords" disabled>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="totalExportValue" class="form-label">Total Export Value</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="totalExportValue" disabled>
                        <span class="input-group-text currency-display"></span>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="totalGstValue" class="form-label">Total GST Value (Sum of IGST)</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="totalGstValue" disabled>
                        <span class="input-group-text currency-display"></span>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="totalInvoiceValue" class="form-label">Total Invoice Value</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="totalInvoiceValue" disabled>
                        <span class="input-group-text currency-display"></span>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="numberOfBoxes" class="form-label">Number of Boxes</label>
                    <input type="number" class="form-control" id="numberOfBoxes" value="1" min="1" disabled>
                </div>
            </div>

            <div class="text-center pt-4 border-top mt-4">
                <button type="submit" id="submitBtn" class="btn btn-success btn-lg" style="background-color: #28a745; border-color: #28a745; color: white; font-weight: bold;">‚úì Update</button>
                <a href="/zc_exporter/view" class="btn btn-lg ms-2" style="background-color: #6c757d; border-color: #6c757d; color: white; font-weight: bold;">‚Ü© Cancel</a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variable to keep track of the number of rows created
        let rowCount = 0;

        // Get record ID from URL
        const recordId = new URLSearchParams(window.location.search).get('id');

        // Currency symbol mapping
        const currencySymbolMap = {
            USD: '$',
            INR: '‚Çπ',
            EUR: '‚Ç¨'
        };

        // Function to update currency symbols throughout the form
        function updateCurrencySymbols() {
            const currencySelect = document.getElementById('currencySelect');
            const symbol = currencySymbolMap[currencySelect.value] || '';
            document.querySelectorAll('.currency-display').forEach(el => el.textContent = symbol);
        }

        // Function to generate the HTML for a new item row
        function createNewRow(initialPackageStart, initialPackageEnd, rowData = {}) {
            rowCount++;
            const startNum = initialPackageStart || 1;
            const endNum = initialPackageEnd || (startNum + 9);
            
            return `
                <tr class="item-row" data-row-id="${rowCount}">
                    <td>
                        <input type="number" class="form-control form-control-sm package-from" value="${rowData.from || startNum}" min="1">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm package-to" value="${rowData.to || endNum}" min="${startNum}">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm description" placeholder="Description of Goods" value="${rowData.description || ''}">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm unit" value="${rowData.unit || 0}" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm quantity" value="${rowData.quantity || 0}" min="0">
                    </td>
                    <td>
                        <div class="d-flex align-items-center justify-content-end">
                            <input type="number" class="form-control form-control-sm rate" value="${rowData.rate || '0.00'}" min="0" step="0.01" style="flex: 1;">
                            <span class="currency-display ms-2" style="min-width: 15px;"></span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center justify-content-end">
                            <input type="text" class="form-control form-control-sm amount" value="${rowData.amount || '0.00'}" disabled style="flex: 1;">
                            <span class="currency-display ms-2" style="min-width: 15px;"></span>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm taxable-value" value="${rowData.taxableValue || '0.00'}" min="0" step="0.01">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm igst-percent" value="${rowData.igstPercent || 0}" min="0" max="100" step="0.01">
                    </td>
                    <td>
                        <div class="d-flex align-items-center justify-content-end">
                            <input type="text" class="form-control form-control-sm igst-amount" value="${rowData.igstAmount || '0.00'}" disabled style="flex: 1;">
                            <span class="currency-display ms-2" style="min-width: 15px;"></span>
                        </div>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm delete-row-btn" style="background-color: #dc3545; border-color: #dc3545; color: white; font-weight: bold;">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }

        // Function to calculate amount for a single row
        function calculateRowAmount(row) {
            const unit = parseFloat(row.querySelector('.unit').value) || 0;
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const amount = (unit * quantity * rate).toFixed(2);
            row.querySelector('.amount').value = amount;
            
            // Calculate IGST Amount = (IGST % / 100) * Taxable Value
            const taxableValue = parseFloat(row.querySelector('.taxable-value').value) || 0;
            const igstPercent = parseFloat(row.querySelector('.igst-percent').value) || 0;
            const igstAmount = ((igstPercent / 100) * taxableValue).toFixed(2);
            row.querySelector('.igst-amount').value = igstAmount;
            
            return parseFloat(amount);
        }

        // Function to convert number to words
        function numberToWords(n) {
            if (isNaN(n) || n === 0) return "zero euro, zero cents";
            const [euros, cents = '00'] = String(n.toFixed(2)).split('.');
            return `${euros} euro and ${cents} cents`;
        }

        // Function to recalculate all totals
        function updateTotals() {
            let totalExportValue = 0;
            let totalGstValue = 0;
            
            document.querySelectorAll('.item-row').forEach(row => {
                // Sum all Amount values for Total Export Value
                const amount = parseFloat(row.querySelector('.amount').value) || 0;
                totalExportValue += amount;
                
                // Sum all IGST Amount values for Total GST Value
                const igstAmount = parseFloat(row.querySelector('.igst-amount').value) || 0;
                totalGstValue += igstAmount;
            });

            // Update Total Export Value
            document.getElementById('totalExportValue').value = totalExportValue.toFixed(2);
            
            // Update Total GST Value (sum of all IGST amounts)
            document.getElementById('totalGstValue').value = totalGstValue.toFixed(2);
            
            // Total Invoice Value = Total Export Value + Total GST Value
            const totalInvoiceValue = totalExportValue + totalGstValue;
            document.getElementById('totalInvoiceValue').value = totalInvoiceValue.toFixed(2);

            const rows = document.querySelectorAll('.item-row');
            if (rows.length > 0) {
                const lastRow = rows[rows.length - 1];
                const lastToValue = parseInt(lastRow.querySelector('.package-to').value, 10) || 1;
                document.getElementById('numberOfBoxes').value = lastToValue;
            }

            // Update Amount in Words based on Total Invoice Value
            document.getElementById('amountInWords').value = numberToWords(totalInvoiceValue);
        }

        // Function to update package sequence
        function updatePackageSequence(changedRow) {
            const rows = document.querySelectorAll('.item-row');
            const changedRowIndex = changedRow ? Array.from(rows).indexOf(changedRow) : -1;
            let currentStart = 1;

            rows.forEach((row, index) => {
                const fromInput = row.querySelector('.package-from');
                const toInput = row.querySelector('.package-to');
                let rowRangeWidth = 0;

                fromInput.value = currentStart;

                if (index < changedRowIndex) {
                    currentStart = parseInt(toInput.value, 10) + 1;
                    return;
                }
                
                if (index === changedRowIndex) {
                    let currentEnd = parseInt(toInput.value, 10);
                    if (currentEnd < currentStart) {
                        currentEnd = currentStart;
                        toInput.value = currentEnd;
                    }
                    rowRangeWidth = currentEnd - currentStart + 1;
                } else {
                    rowRangeWidth = (parseInt(toInput.value, 10) - parseInt(fromInput.value, 10) + 1) || 10;
                    let newEnd = currentStart + rowRangeWidth - 1;
                    toInput.value = newEnd;
                }

                currentStart = parseInt(toInput.value, 10) + 1;
            });
        }

        // Load record data from database
        function loadRecordData() {
            if (!recordId) {
                return;
            }

            fetch(`/api/zc-exporter/${recordId}`)
                .then(response => response.json())
                .then(data => {
                    // Populate form fields
                    document.getElementById('invoiceNumber').value = data.invoiceNumber || '';
                    document.getElementById('invoiceDate').value = data.invoiceDate || '';
                    document.getElementById('buyerOrderNumber').value = data.buyerOrderNumber || '';
                    document.getElementById('buyerOrderDate').value = data.buyerOrderDate || '';
                    document.getElementById('exporterReference').value = data.exporterReference || '';
                    document.getElementById('iecNumber').value = data.iecNumber || '';
                    document.getElementById('taxRegistrationNumber').value = data.taxRegistrationNumber || '';
                    document.getElementById('lutArnNumber').value = data.lutArnNumber || '';
                    document.getElementById('deliveryPaymentTerms').value = data.deliveryPaymentTerms || '';
                    document.getElementById('portOfLoading').value = data.portOfLoading || '';
                    document.getElementById('portOfDischarge').value = data.portOfDischarge || '';
                    document.getElementById('preCarriageBy').value = data.preCarriageBy || '';
                    document.getElementById('placeOfReceipt').value = data.placeOfReceipt || '';
                    document.getElementById('portOfDestination').value = data.portOfDestination || '';
                    document.getElementById('destination').value = data.destination || '';
                    document.getElementById('currencySelect').value = data.currency || 'EUR';
                    document.getElementById('vesselFlight').value = data.vesselFlight || '';
                    document.getElementById('countryOfOrigin').value = data.countryOfOrigin || '';
                    document.getElementById('adCode').value = data.adCode || '';
                    document.getElementById('otherReference').value = data.otherReference || '';
                    document.getElementById('hsCode').value = data.hsCode || '';
                    document.getElementById('finalDestination').value = data.finalDestination || '';
                    document.getElementById('contactPersonName').value = data.contactPersonName || '';
                    document.getElementById('contactEmail').value = data.contactEmail || '';
                    document.getElementById('consigneeAddress').value = data.consigneeAddress || '';
                    document.getElementById('deliveryAddress').value = data.deliveryAddress || '';
                    
                    // Auto-expand textareas after loading data
                    document.querySelectorAll('.auto-expand').forEach(textarea => {
                        autoExpandTextarea(textarea);
                    });
                    
                    // Load items into table
                    const container = document.getElementById('itemDetailsContainer');
                    container.innerHTML = '';
                    if (data.items && Array.isArray(data.items) && data.items.length > 0) {
                        data.items.forEach(item => {
                            container.insertAdjacentHTML('beforeend', createNewRow(item.from, item.to, item));
                        });
                    } else {
                        // Add one empty row if no items
                        container.insertAdjacentHTML('beforeend', createNewRow(1, 10));
                    }
                    
                    updateTotals();
                    updateCurrencySymbols();
                    
                    document.getElementById('amountInWords').value = data.amountInWords || '';
                    document.getElementById('totalExportValue').value = data.totalExportValue || '0.00';
                    document.getElementById('totalGstValue').value = data.totalGstValue || '0.00';
                    document.getElementById('totalInvoiceValue').value = data.totalInvoiceValue || '0.00';
                    document.getElementById('numberOfBoxes').value = data.numberOfBoxes || '1';
                })
                .catch(error => {
                    console.log('Could not load record:', error);
                });
        }

        // Form submit handler
        document.getElementById('exportInvoiceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Collect all items from table
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({
                    from: row.querySelector('.package-from').value,
                    to: row.querySelector('.package-to').value,
                    description: row.querySelector('.description').value,
                    unit: row.querySelector('.unit').value,
                    quantity: row.querySelector('.quantity').value,
                    rate: row.querySelector('.rate').value,
                    amount: row.querySelector('.amount').value,
                    taxableValue: row.querySelector('.taxable-value').value,
                    igstPercent: row.querySelector('.igst-percent').value,
                    igstAmount: row.querySelector('.igst-amount').value
                });
            });
            
            const payload = {
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                buyerOrderNumber: document.getElementById('buyerOrderNumber').value,
                buyerOrderDate: document.getElementById('buyerOrderDate').value,
                exporterReference: document.getElementById('exporterReference').value,
                iecNumber: document.getElementById('iecNumber').value,
                taxRegistrationNumber: document.getElementById('taxRegistrationNumber').value,
                lutArnNumber: document.getElementById('lutArnNumber').value,
                deliveryPaymentTerms: document.getElementById('deliveryPaymentTerms').value,
                portOfLoading: document.getElementById('portOfLoading').value,
                portOfDischarge: document.getElementById('portOfDischarge').value,
                preCarriageBy: document.getElementById('preCarriageBy').value,
                placeOfReceipt: document.getElementById('placeOfReceipt').value,
                portOfDestination: document.getElementById('portOfDestination').value,
                destination: document.getElementById('destination').value,
                currency: document.getElementById('currencySelect').value,
                vesselFlight: document.getElementById('vesselFlight').value,
                countryOfOrigin: document.getElementById('countryOfOrigin').value,
                adCode: document.getElementById('adCode').value,
                otherReference: document.getElementById('otherReference').value,
                hsCode: document.getElementById('hsCode').value,
                finalDestination: document.getElementById('finalDestination').value,
                contactPersonName: document.getElementById('contactPersonName').value,
                contactEmail: document.getElementById('contactEmail').value,
                consigneeAddress: document.getElementById('consigneeAddress').value,
                deliveryAddress: document.getElementById('deliveryAddress').value,
                amountInWords: document.getElementById('amountInWords').value,
                totalExportValue: document.getElementById('totalExportValue').value,
                totalGstValue: document.getElementById('totalGstValue').value,
                totalInvoiceValue: document.getElementById('totalInvoiceValue').value,
                numberOfBoxes: document.getElementById('numberOfBoxes').value,
                items: items
            };
            
            // Send data to server
            fetch(`/api/zc-exporter/${recordId}/update`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Export invoice updated successfully!');
                    // Redirect to view page
                    window.location.href = '/zc_exporter/view';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error updating form: ' + error);
                console.error('Error:', error);
            });
        });

        // Function to auto-expand textarea based on content
        function autoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(textarea.scrollHeight, parseInt(getComputedStyle(textarea).minHeight)) + 'px';
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('itemDetailsContainer');
            const addRowBtn = document.getElementById('addRowBtn');
            const removeRowBtn = document.getElementById('removeRowBtn');

            loadRecordData();
            
            // Currency change listener
            const currencySelect = document.getElementById('currencySelect');
            if (currencySelect) {
                currencySelect.addEventListener('change', updateCurrencySymbols);
            }
            
            // Initialize auto-expand textareas
            document.querySelectorAll('.auto-expand').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    autoExpandTextarea(this);
                });
            });

            // Add Row Listener
            addRowBtn.addEventListener('click', () => {
                const rows = document.querySelectorAll('.item-row');
                let nextStart = 1;
                
                if (rows.length > 0) {
                    const lastRowTo = parseInt(rows[rows.length - 1].querySelector('.package-to').value, 10) || 0;
                    nextStart = lastRowTo + 1;
                }
                
                container.insertAdjacentHTML('beforeend', createNewRow(nextStart, nextStart + 9));
                updateTotals();
            });

            // Remove Last Row Listener
            removeRowBtn.addEventListener('click', () => {
                const rows = container.querySelectorAll('.item-row');
                if (rows.length > 1) {
                    container.removeChild(rows[rows.length - 1]);
                    updatePackageSequence(null);
                    updateTotals();
                }
            });

            // Dynamic Input Listener for all item rows
            container.addEventListener('input', (event) => {
                const target = event.target;
                const row = target.closest('.item-row');

                if (!row) return;

                if (target.classList.contains('unit') || target.classList.contains('quantity') || target.classList.contains('rate')) {
                    calculateRowAmount(row);
                    updateTotals();
                }

                // Listener for Taxable Value and IGST % changes
                if (target.classList.contains('taxable-value') || target.classList.contains('igst-percent')) {
                    calculateRowAmount(row);
                    updateTotals();
                }

                if (target.classList.contains('package-from') || target.classList.contains('package-to')) {
                    let val = parseInt(target.value, 10);
                    if (isNaN(val) || val < 1) val = 1;
                    target.value = val;

                    const fromInput = row.querySelector('.package-from');
                    const toInput = row.querySelector('.package-to');
                    const changedField = target.classList.contains('package-from') ? 'from' : 'to';

                    if (parseInt(fromInput.value, 10) > parseInt(toInput.value, 10)) {
                        if (changedField === 'from') {
                            toInput.value = fromInput.value;
                        } else {
                            fromInput.value = toInput.value;
                        }
                    }

                    updatePackageSequence(row);
                }

                if (target.classList.contains('unit') || target.classList.contains('quantity') || target.classList.contains('rate') || target.classList.contains('package-from') || target.classList.contains('package-to')) {
                    updateTotals();
                }
            });

            // Delete Specific Row Listener
            container.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-row-btn')) {
                    const rowToDelete = event.target.closest('.item-row');
                    if (container.querySelectorAll('.item-row').length > 1) {
                        container.removeChild(rowToDelete);
                        updatePackageSequence(null);
                        updateTotals();
                    } else {
                        alert("Cannot delete the last remaining row.");
                    }
                }
            });
        });
    </script>
</body>
</html>
